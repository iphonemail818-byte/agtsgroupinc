<script>
flatpickr("#pickupDate",{minDate:"today"});
flatpickr("#pickupTime",{enableTime:true,noCalendar:true,dateFormat:"h:i K"});

const f=id=>document.getElementById(id);

const mandatory=[
  "pickup","dropoff","pickupDate","pickupTime",
  "vehicle","passengers","pets","name","phone","email"
].map(f);

function show(id){f(id).classList.add("show")}

pickup.onchange=dropoff.onchange=()=>{
  if(pickup.value && dropoff.value) show("dateField");
};

pickupDate.onchange=()=>show("timeField");

pickupTime.onchange=()=>{
  show("vehicleField");
  show("passengersField");
  show("petsField");
};

pets.onchange=()=>{
  show("nameField");
  show("phoneField");
  show("emailField");
  payBtn.style.display="block";
};

mandatory.forEach(el=>{
  el.addEventListener("input",()=>el.classList.remove("input-error"));
});

function validate(){
  let first=null;
  mandatory.forEach(el=>{
    el.classList.remove("input-error");
    if(!el.value && !first){
      el.classList.add("input-error");
      first=el;
    }
  });
  if(first){
    first.focus();
    return false;
  }
  return true;
}

payBtn.onclick=()=>{
  if(!validate()) return;

  const service=new google.maps.DistanceMatrixService();

  service.getDistanceMatrix({
    origins:[pickup.value],
    destinations:[dropoff.value],
    travelMode:google.maps.TravelMode.DRIVING,
    unitSystem:google.maps.UnitSystem.IMPERIAL
  },(res,status)=>{
    if(status!=="OK"){
      alert("Unable to calculate distance. Please try again.");
      return;
    }

    const element=res.rows[0].elements[0];
    if(element.status!=="OK"){
      alert("Route not found.");
      return;
    }

    const miles=element.distance.value/1609.34;
    const durationText=element.duration.text;

    // ðŸ”¥ UBER / LYFT STYLE â€” 20% CHEAPER
    const baseFare=25;
    const perMile=3.2;
    let price=(baseFare + miles*perMile);

    // Vehicle multiplier
    price*=parseFloat(vehicle.value);

    price=Math.max(price,45).toFixed(2);

    tripSummary.style.display="block";

    sumRoute.textContent=`${pickup.value} â†’ ${dropoff.value}`;
    sumDate.textContent=`${pickupDate.value} at ${pickupTime.value}`;
    sumVehicle.textContent=
      `Vehicle: ${vehicle.options[vehicle.selectedIndex].text} | Passengers: ${passengers.value} | Pets: ${pets.value}`;
    sumDuration.textContent=`Estimated Duration: ${durationText}`;
    sumPrice.textContent=`Estimated Price: $${price}`;
  });
};

function initAutocomplete(){
  new google.maps.places.Autocomplete(pickup,{types:["geocode"]});
  new google.maps.places.Autocomplete(dropoff,{types:["geocode"]});
}
</script>
